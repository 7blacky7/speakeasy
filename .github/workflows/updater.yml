name: Updater JSON generieren

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  generate-updater-json:
    name: latest.json fÃ¼r Tauri-Updater generieren
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Release-Informationen abrufen
        id: release
        uses: actions/github-script@v7
        with:
          script: |
            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: context.payload.release.tag_name
            });
            core.setOutput('tag', context.payload.release.tag_name);
            core.setOutput('notes', release.data.body || '');
            core.setOutput('date', release.data.published_at);
            return release.data;

      - name: latest.json generieren
        run: |
          VERSION="${{ steps.release.outputs.tag }}"
          VERSION_NUM="${VERSION#v}"
          REPO="7blacky7/speakeasy"
          BASE_URL="https://github.com/${REPO}/releases/download/${VERSION}"

          cat > latest.json << EOF
          {
            "version": "${VERSION_NUM}",
            "notes": "${{ steps.release.outputs.notes }}",
            "pub_date": "${{ steps.release.outputs.date }}",
            "platforms": {
              "linux-x86_64": {
                "signature": "",
                "url": "${BASE_URL}/speakeasy_${VERSION_NUM}_amd64.AppImage"
              },
              "windows-x86_64": {
                "signature": "",
                "url": "${BASE_URL}/speakeasy_${VERSION_NUM}_x64-setup.exe"
              },
              "darwin-x86_64": {
                "signature": "",
                "url": "${BASE_URL}/speakeasy_${VERSION_NUM}_x64.dmg"
              },
              "darwin-aarch64": {
                "signature": "",
                "url": "${BASE_URL}/speakeasy_${VERSION_NUM}_aarch64.dmg"
              }
            }
          }
          EOF

      - name: latest.json als Release-Asset hochladen
        uses: softprops/action-gh-release@v2
        with:
          files: latest.json
